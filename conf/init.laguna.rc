import /vendor/etc/init/hw/init.efs.rc
import /vendor/etc/init/hw/init.laguna.usb.rc
import /vendor/etc/init/hw/init.persist.rc
import android.hardware.drm@1.2-service.widevine.rc

on early-init
    write /proc/sys/kernel/sched_pelt_multiplier 1
    write /sys/kernel/mm/lru_gen/enabled n
    write /sys/firmware/mbfs_root/cherry_pick cpm/dbg/uart_log
    write /sys/firmware/mbfs_root/cherry_pick cpm/sched/dw_stats/ResetAllStats
    write /sys/firmware/mbfs_root/cpm/dbg/uart_log 0
    write /sys/firmware/mbfs_root/cpm/sched/dw_stats/ResetAllStats 1

on init
    # CPU0 cannot be offline
    chmod 0444 /sys/devices/system/cpu/cpu0/online

    # Set teo as cpu idle governor
    write /sys/devices/system/cpu/cpuidle/current_governor teo
    write /proc/vendor_sched/teo_util_threshold "1024 1024 1024 1024 1024 1024 1024 1024"

    # Boot time fs tuning
    write /sys/block/sda/queue/scheduler mq-deadline

    chown system system /sys/devices/system/cpu/cpufreq/policy0/sched_pixel/lcpi_threshold
    chown system system /sys/devices/system/cpu/cpufreq/policy0/sched_pixel/spc_threshold
    chown system system /sys/devices/system/cpu/cpufreq/policy0/sched_pixel/limit_frequency
    chown system system /sys/devices/system/cpu/cpufreq/policy0/sched_pixel/pmu_limit_enable
    chown system system /sys/devices/system/cpu/cpufreq/policy2/sched_pixel/lcpi_threshold
    chown system system /sys/devices/system/cpu/cpufreq/policy2/sched_pixel/spc_threshold
    chown system system /sys/devices/system/cpu/cpufreq/policy2/sched_pixel/limit_frequency
    chown system system /sys/devices/system/cpu/cpufreq/policy2/sched_pixel/pmu_limit_enable
    chown system system /sys/devices/system/cpu/cpufreq/policy5/sched_pixel/lcpi_threshold
    chown system system /sys/devices/system/cpu/cpufreq/policy5/sched_pixel/spc_threshold
    chown system system /sys/devices/system/cpu/cpufreq/policy5/sched_pixel/limit_frequency
    chown system system /sys/devices/system/cpu/cpufreq/policy5/sched_pixel/pmu_limit_enable
    chown system system /sys/devices/system/cpu/cpufreq/policy7/sched_pixel/lcpi_threshold
    chown system system /sys/devices/system/cpu/cpufreq/policy7/sched_pixel/spc_threshold
    chown system system /sys/devices/system/cpu/cpufreq/policy7/sched_pixel/limit_frequency
    chown system system /sys/devices/system/cpu/cpufreq/policy7/sched_pixel/pmu_limit_enable

    start vendor.keymaster-4-0

    # ZRAM Common Setup
    write /proc/sys/vm/page-cluster 0

    # Some user code relies on ro.boot.hardware.revision
    setprop ro.boot.hardware.revision ${ro.revision}

    # Allow PAI targeting per hardware SKU
    setprop ro.oem.key1 ${ro.boot.hardware.sku}

    # Property used by vintf for sku specific manifests
    # Property used by NFC for sku specific configurations
    setprop ro.boot.product.hardware.sku ${ro.boot.hardware.sku}

    # Support legacy paths
    symlink /data/app /factory

    # Apply network parameters for high data performance.
    write /proc/sys/net/core/rmem_default 327680
    write /proc/sys/net/core/rmem_max 8388608
    write /proc/sys/net/core/wmem_default 327680
    write /proc/sys/net/core/wmem_max 8388608
    write /proc/sys/net/core/optmem_max 20480
    write /proc/sys/net/core/netdev_max_backlog 10000
    write /proc/sys/net/ipv4/tcp_rmem "2097152 4194304 8388608"
    write /proc/sys/net/ipv4/tcp_wmem "262144 524288 8388608"
    write /proc/sys/net/ipv4/tcp_mem "44259 59012 88518"
    write /proc/sys/net/ipv4/udp_mem "88518 118025 177036"

    # Disable TCP cubic HYSTART_ACK_TRAIN and HYSTART_DELAY for high data performance.
    write /sys/module/tcp_cubic/parameters/hystart_detect 0

    write /sys/class/net/rmnet0/queues/rx-0/rps_cpus fe
    write /sys/class/net/rmnet1/queues/rx-0/rps_cpus fe
    write /sys/class/net/rmnet2/queues/rx-0/rps_cpus fe
    write /sys/class/net/rmnet3/queues/rx-0/rps_cpus fe
    write /sys/class/net/rmnet4/queues/rx-0/rps_cpus fe
    write /sys/class/net/rmnet5/queues/rx-0/rps_cpus fe
    write /sys/class/net/rmnet6/queues/rx-0/rps_cpus fe
    write /sys/class/net/rmnet7/queues/rx-0/rps_cpus fe

    # Boot time 183626384
    write /proc/vendor_sched/groups/ta/uclamp_min 1024
    write /proc/vendor_sched/groups/ta/prefer_idle 1
    write /proc/vendor_sched/groups/fg/uclamp_min 1024
    write /proc/vendor_sched/groups/fg/prefer_idle 1
    write /proc/vendor_sched/groups/sys/uclamp_min 1024
    write /proc/vendor_sched/groups/sys/prefer_idle 1
    # Boot time mempath boosting
    write /sys/devices/platform/gmc_freq/devfreq/gmc_freq/vote_manager/powerhint_min_freq 3148000000
    write /sys/devices/platform/memss_freq/devfreq/memss_freq/vote_manager/powerhint_min_freq 800000000
    write /sys/devices/platform/200c0780.dsufreq/devfreq/200c0780.dsufreq/vote_manager/powerhint_min_freq 1843000000
    write /sys/class/devfreq/fabhbw_freq/vote_manager/powerhint_min_freq 666000000
    write /sys/class/devfreq/inftcu_freq/vote_manager/powerhint_min_freq 480000000
    write /sys/class/devfreq/fabsyss_freq/vote_manager/powerhint_min_freq 480000000
    write /sys/class/devfreq/fabmed_freq/vote_manager/powerhint_min_freq 533000000

    # Map HBW_GPU dvfsMon
    write /sys/firmware/mbfs_root/cherry_pick cpm/perf/dvfsmon/HBW_GPU/enable
    write /sys/firmware/mbfs_root/cherry_pick cpm/tracing/kevlog/dwJobH.log.us
    write /sys/firmware/mbfs_root/cherry_pick cpm/tracing/kevlog/dwLatH.log.us
    write /sys/firmware/mbfs_root/cherry_pick cpm/tracing/kevlog/irqs.log.us

    # enable HBW_GPU dvfsMon
    write /sys/firmware/mbfs_root/cpm/perf/dvfsmon/HBW_GPU/enable 1

    write /sys/firmware/mbfs_root/cpm/tracing/kevlog/dwJobH.log.us 1500
    write /sys/firmware/mbfs_root/cpm/tracing/kevlog/dwLatH.log.us 2500
    write /sys/firmware/mbfs_root/cpm/tracing/kevlog/irqs.log.us 200

    # Map GMC urg ACG
    write /sys/firmware/mbfs_root/cherry_pick cpm/pwr/hw_lpms/gmc/fe.cg_en_rurg_pm
    write /sys/firmware/mbfs_root/cherry_pick cpm/pwr/hw_lpms/gmc/fe.cg_en_wurg_pm

    # Map Tj reset_trip_count
    write /sys/firmware/mbfs_root/cherry_pick cpm/thermal/tj/AOC/reset_trip_cnt
    write /sys/firmware/mbfs_root/cherry_pick cpm/thermal/tj/AUR/reset_trip_cnt
    write /sys/firmware/mbfs_root/cherry_pick cpm/thermal/tj/BIG/reset_trip_cnt
    write /sys/firmware/mbfs_root/cherry_pick cpm/thermal/tj/BIG_MID/reset_trip_cnt
    write /sys/firmware/mbfs_root/cherry_pick cpm/thermal/tj/GPU/reset_trip_cnt
    write /sys/firmware/mbfs_root/cherry_pick cpm/thermal/tj/LITTLE/reset_trip_cnt
    write /sys/firmware/mbfs_root/cherry_pick cpm/thermal/tj/MID/reset_trip_cnt
    write /sys/firmware/mbfs_root/cherry_pick cpm/thermal/tj/TPU/reset_trip_cnt

    # Provisionally disable GMC urg ACG by default (b/379739109)
    write /sys/firmware/mbfs_root/cpm/pwr/hw_lpms/gmc/fe.cg_en_rurg_pm 0
    write /sys/firmware/mbfs_root/cpm/pwr/hw_lpms/gmc/fe.cg_en_wurg_pm 0

    mkdir /dev/cpuset/camera-daemon-high-group
    write /dev/cpuset/camera-daemon-high-group/cpus 0-7
    write /dev/cpuset/camera-daemon-high-group/mems 0
    chown system system /dev/cpuset/camera-daemon-high-group/tasks
    chmod 0664 /dev/cpuset/camera-daemon-high-group/tasks

    mkdir /dev/cpuset/camera-daemon-mid-group
    write /dev/cpuset/camera-daemon-mid-group/cpus 0-7
    write /dev/cpuset/camera-daemon-mid-group/mems 0
    chown system system /dev/cpuset/camera-daemon-mid-group/tasks
    chmod 0664 /dev/cpuset/camera-daemon-mid-group/tasks

    mkdir /dev/cpuset/camera-daemon-mid-low-group
    write /dev/cpuset/camera-daemon-mid-low-group/cpus 0-7
    write /dev/cpuset/camera-daemon-mid-low-group/mems 0
    chown system system /dev/cpuset/camera-daemon-mid-low-group/tasks
    chmod 0664 /dev/cpuset/camera-daemon-mid-low-group/tasks

    mkdir /dev/cpuset/camera-daemon-mid-high-group
    write /dev/cpuset/camera-daemon-mid-high-group/cpus 0-7
    write /dev/cpuset/camera-daemon-mid-high-group/mems 0
    chown system system /dev/cpuset/camera-daemon-mid-high-group/tasks
    chmod 0664 /dev/cpuset/camera-daemon-mid-high-group/tasks

    # nanohub sensor
    chmod 0664 /dev/nanohub
    chmod 0664 /dev/nanohub_comms
    chown system system /dev/nanohub
    chown system system /dev/nanohub_comms

    # Loading common kernel modules in background
    start init_display

    # Power Stats HAL
    chown system system /dev/bbd_pwrstat

    # Give pixelstats group access to PCIe link statistics counters
    chown system system /sys/devices/platform/12100000.pcie/link_stats/complete_timeout_irqs
    chown system system /sys/devices/platform/12100000.pcie/link_stats/link_down_irqs
    chown system system /sys/devices/platform/12100000.pcie/link_stats/link_recovery_failures
    chown system system /sys/devices/platform/12100000.pcie/link_stats/link_up_failures
    chown system system /sys/devices/platform/13120000.pcie/link_stats/complete_timeout_irqs
    chown system system /sys/devices/platform/13120000.pcie/link_stats/link_down_irqs
    chown system system /sys/devices/platform/13120000.pcie/link_stats/link_recovery_failures
    chown system system /sys/devices/platform/13120000.pcie/link_stats/link_up_failures

    # Change GSA log group for dumpstate
    chown root system /sys/devices/platform/16490000.gsa-ns/log_main
    chown root system /sys/devices/platform/16490000.gsa-ns/log_intermediate

    # Prefer Asymmetric MTE mode when enabled
    write /sys/devices/system/cpu/cpu0/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu1/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu2/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu3/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu4/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu5/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu6/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu7/mte_tcf_preferred asymm

    # Enable transparent hugepages
    write /sys/kernel/mm/transparent_hugepage/shmem_enabled advise

# ZRAM setup: use EH in 4kb kernels.
on init && property:ro.boot.hardware.cpu.pagesize=4096
    write /sys/block/zram0/comp_algorithm lz77eh

# ZRAM setup: do not use EH in 16kb kernels.
on init && property:ro.boot.hardware.cpu.pagesize=16384
    write /sys/block/zram0/comp_algorithm lz4

on post-fs
    # Ensure device is ready and start storageproxyd
    wait /dev/sg1
    start storageproxyd

on late-fs
    # Start bootanimation class before mount
    start bootanim
    class_start animation

    # Mount RW partitions which need run fsck
    mount_all --late

on post-fs-data
    # Log data folder
    mkdir /data/vendor 0771 radio system
    mkdir /data/vendor/log 0771 radio system
    mkdir /data/vendor/log/cbd 0771 radio system
    mkdir /data/vendor/log/rfsd 0771 radio system

    mkdir /data/exynos/log 0771 radio system
    mkdir /data/vendor/rild 0771 radio system
    mkdir /data/vendor/dump 0771 radio system
    mkdir /data/vendor/slog 0771 system system

    # PixelLogger log paths.
    mkdir /data/vendor/radio 773 system radio
    mkdir /data/vendor/radio/logs 773 system radio
    mkdir /data/vendor/radio/logs/always-on 777 system radio

    # Modem extended log folder
    mkdir /data/vendor/radio/extended_logs 0771 radio system

    # Modem MDS log folder
    mkdir /data/vendor/radio/mds 0771 radio system

    # Unzipped modem images folder
    mkdir /data/vendor/radio/image 0771 radio system

    # Modem stat folder
    mkdir /data/vendor/modem_stat 0771 radio system
    write /data/vendor/modem_stat/debug.txt ""
    chown radio system /data/vendor/modem_stat/debug.txt
    chmod 0664 /data/vendor/modem_stat/debug.txt

    # Modem replay folder
    mkdir /mnt/vendor/modem_userdata/replay 0775 radio system

    # Write display MIPI frequency from Modem
    chown system system /sys/devices/platform/sswrp_dpu@ec00000/efd8000.dsi2host/dw-dsi/hs_clock
    chown system system /sys/devices/platform/sswrp_dpu@ec00000/eff8000.dsi2host/dw-dsi/hs_clock
    chown system system /sys/class/drm/card0/device/primary-panel/backlight/panel0-backlight/ssc_en
    chmod 0664 /sys/devices/platform/sswrp_dpu@ec00000/efd8000.dsi2host/dw-dsi/hs_clock
    chmod 0664 /sys/devices/platform/sswrp_dpu@ec00000/eff8000.dsi2host/dw-dsi/hs_clock
    chmod 0664 /sys/class/drm/card0/device/primary-panel/backlight/panel0-backlight/ssc_en

    # IPSEC PIDDIR for VoWiFi
    mkdir /data/vendor/misc 0771 root system
    mkdir /data/vendor/misc/vpn 0771 root system

    # Permissions Camera
    mkdir /data/vendor/camera 0770 system camera
    mkdir /data/vendor/camera/catpipe 0770 system camera
    mkdir /data/vendor/android.hardware.camera.provider@2.7-service-google 0770 system camera
    chmod 0755 /sys/kernel/debug/tracing
    restorecon /sys/kernel/debug/tracing/trace_marker

    # ranging sensor
    chown system system /dev/stmvl53l1_ranging
    chmod 0660 /dev/stmvl53l1_ranging

    # Audio dump and debug
    mkdir /data/vendor/audio 0770 system audio

    # Create the directories for Darwinn HAL.
    mkdir /data/vendor/hal_neuralnetworks_darwinn 0770 system system
    mkdir /data/vendor/hal_neuralnetworks_darwinn/checksum_cache 0770 system system
    mkdir /data/vendor/edgetpu 0770 system system
    mkdir /data/vendor/edgetpu/cache 0770 system system

    # Compatibility path for TPU
    symlink /dev/edgetpu-soc /dev/edgetpu

on zygote-start
    # For PixelLogger configuration file.
    chmod 0771 /data/vendor/wifi
    # Boot time tuning. Prefer BC and MC.
    write /proc/vendor_sched/groups/ta/uclamp_min 687
    write /proc/vendor_sched/groups/ta/prefer_high_cap 1
    write /proc/vendor_sched/groups/fg/uclamp_min 687
    write /proc/vendor_sched/groups/fg/prefer_high_cap 1
    write /proc/vendor_sched/groups/sys/uclamp_min 687
    write /proc/vendor_sched/groups/sys/prefer_high_cap 1

    # Boot time tuning. Group throttle
    # Use per group setting instead
    write /proc/vendor_sched/groups/bg/ug 0
    write /proc/vendor_sched/groups/sys_bg/ug 2
    write /proc/vendor_sched/groups/ota/ug 0
    write /proc/vendor_sched/groups/dex2oat/ug 0
    write /proc/vendor_sched/groups/ta/ug 1
    write /proc/vendor_sched/groups/fg/ug 1
    write /proc/vendor_sched/groups/nnapi/ug 0
    write /proc/vendor_sched/groups/rt/ug 2
    write /proc/vendor_sched/groups/sf/ug 2
    write /proc/vendor_sched/groups/sys/ug 1

on post-fs-data
    # Create the directories used by the Wireless subsystem
    mkdir /data/vendor/wifi 0771 wifi wifi
    mkdir /data/vendor/wifi/wpa 0770 wifi wifi
    mkdir /data/vendor/wifi/wpa/sockets 0770 wifi wifi

# Gatekeeper data
    mkdir /data/vendor/gk 0771 system system

# HWC data
    mkdir /data/vendor/log/hwc 0771 system graphics

# Video data
    mkdir /data/vendor/media 0700 mediacodec mediacodec

on post-fs-data
    # GPS
    mkdir /data/vendor/gps 0771 system system
    chown system system /data/vendor/gps
    rm /data/vendor/gps/gps_started
    rm /data/vendor/gps/glonass_started
    rm /data/vendor/gps/beidou_started
    rm /data/vendor/gps/smd_started
    rm /data/vendor/gps/sv_cno.info

    chown gps system /sys/devices/platform/111e0000.spi/spi_master/spi21/spi21.0/nstandby
    chmod 0664 /dev/ttyBCM
    chown gps system /dev/ttyBCM
    chmod 0664 /dev/bbd_control
    chown gps system /dev/bbd_control
    chmod 0664 /dev/bbd_patch
    chown gps system /dev/bbd_patch
    chmod 0664 /dev/bbd_sensor
    chown gps system /dev/bbd_sensor

on early-boot
    # Wait for insmod_sh to finish all common modules
    wait_for_prop vendor.common.modules.ready 1

    # logbuffer
    chown system system /dev/logbuffer_cpif
    chown system system /dev/logbuffer_pcie0
    chown system system /dev/logbuffer_pcie1

on boot

    # Allow to access debugfs for system:system
    chmod 0755 /sys/kernel/debug
    chown system system /sys/kernel/debug

    #setprop ro.radio.noril no

    # default country code
    setprop ro.boot.wificountrycode 00

    # Set up kernel tracing, but disable it by default
    chmod 0222 /sys/kernel/debug/tracing/trace_marker
    write /sys/kernel/debug/tracing/tracing_on 0

    # Change permission for A-Box firmware logs file & GPR dump
    chown audioserver system /sys/devices/platform/17c50000.abox/reset
    chown audioserver system /sys/devices/platform/17c50000.abox/service
    chown audioserver system /sys/devices/platform/17c50000.abox/0.abox_debug/gpr
    chown audioserver system /sys/devices/platform/17c50000.abox/0.abox_debug/calliope_sram
    chown audioserver system /sys/devices/platform/17c50000.abox/0.abox_debug/calliope_dram
    chown audioserver system /sys/devices/platform/17c50000.abox/0.abox_debug/calliope_iva
    chown audioserver system /sys/kernel/debug/abox/log-00

# Permission for USB SELECT
    chown system system /sys/class/android_usb/android0/enable
    chmod 0660 /sys/class/android_usb/android0/enable
    chown system system /sys/class/android_usb/android0/idVendor
    chmod 0660 /sys/class/android_usb/android0/idVendor
    chown system system /sys/class/android_usb/android0/idProduct
    chmod 0660 /sys/class/android_usb/android0/idProduct
    chown system system /sys/class/android_usb/android0/f_diag/clients
    chmod 0660 /sys/class/android_usb/android0/f_diag/clients
    chown system system /sys/class/android_usb/android0/functions
    chmod 0660 /sys/class/android_usb/android0/functions
    chown system system /sys/class/android_usb/android0/bDeviceClass
    chmod 0660 /sys/class/android_usb/android0/bDeviceClass

# Permission for UART SWITCH
    chmod 0660 /sys/class/sec/switch/uart_sel
    chown system system /sys/class/sec/switch/uart_sel

# VTS sysfs file permission
    chown audioserver system /sys/devices/platform/13810000.vts/vts_svoice_model
    chown audioserver system /sys/devices/platform/13810000.vts/vts_google_model
    chmod 0660 /sys/devices/platform/13810000.vts/vts_svoice_model
    chmod 0660 /sys/devices/platform/13810000.vts/vts_google_model

on property:persist.vendor.radio.no_modem_board=1
    setprop ro.radio.noril yes

on fs
    mount_all --early

    # Mount modem partition
    mount_all /vendor/etc/fstab.modem --early
    restorecon_recursive /mnt/vendor/modem_img

# Permissions for ION
    chmod 0660 /sys/class/ion_cma/ion_video_ext/isolated
    chown system system /sys/class/ion_cma/ion_video_ext/isolated

# Permissions for hwcomposer
    chown system system /sys/class/backlight/panel0-backlight/als_table
    chown system system /sys/class/backlight/panel0-backlight/brightness
    chown system system /sys/class/backlight/panel0-backlight/dimming_on
    chown system system /sys/class/backlight/panel0-backlight/hbm_mode
    chown system system /sys/class/backlight/panel0-backlight/local_hbm_mode
    chown system system /sys/class/drm/card0-DSI-1/panel/min_vrefresh
    chown system system /sys/class/drm/card0-DSI-1/panel/idle_delay_ms
    chown system system /sys/class/drm/card0-DSI-1/panel/panel_idle
    chown system system /sys/class/drm/card0-DSI-1/panel/panel_need_handle_idle_exit
    chown system system /sys/class/drm/card0-DSI-1/panel/op_hz
    chown system system /sys/class/drm/card0-DSI-1/panel/color_data
    chown system system /sys/class/drm/card0-DSI-1/panel/te2_freq_hz
    chown system system /sys/class/drm/card0-DSI-1/panel/te2_option
    chown system system /sys/class/drm/card0-DSI-1/panel/skin_temperature
    chown system system /sys/module/drm/parameters/vblankoffdelay

    chmod 0660 /sys/devices/platform/sswrp_dpu@ec00000/ee00000.dc9x00/early_wakeup
    chown system system /sys/devices/platform/sswrp_dpu@ec00000/ee00000.dc9x00/early_wakeup

# Permissions for ALSP sensor
    chown system system /sys/class/drm/card0-DSI-1/panel/te2_rate_hz
    chown system system /sys/class/drm/card0-DSI-1/panel/pwm_mode

# Copy DRM Key
#    copy /system/app/wv.keys /factory/wv.keys

# Permission for DRM Key
#    chmod 0644 /factory/wv.keys

# Permission for flashlight control for HAL3.3
# The Istor espresso board does not have the flash led h/w, So the below permission line are blocked.
# If you want to test the flashlight in board which have the flash led h/w, Enable the below blocked lines.
    chmod 0660 /sys/class/camera/flash/rear_torch_flash
    chown system camera /sys/class/camera/flash/rear_torch_flash
#load ecd firmware
    write /proc/ecd/load_firmware 1

service abox /vendor/bin/main_abox 17c50000.abox
    class late_start
    user audioserver
    group audioserver
    seclabel u:r:abox:s0

# on userdebug and eng builds, enable kgdb on the serial console
on property:ro.debuggable=1
    write /sys/module/kgdboc/parameters/kgdboc ttyFIQ1
    write /sys/module/fiq_debugger/parameters/kgdb_enable 1

# Touch
on property:vendor.device.modules.ready=1
    chown system system /sys/class/spi_master/spi20/spi20.0/stm_fts_cmd
    chown system system /sys/class/spi_master/spi20/spi20.0/glove_mode
    chown system system /sys/devices/virtual/sec/tsp/fw_version
    chown system system /sys/devices/virtual/sec/tsp/cmd
    chown system system /sys/devices/virtual/sec/tsp/cmd_result
    chown system system /sys/devices/virtual/sec/tsp/status
    chown system system /sys/devices/virtual/goog_touch_interface/gti.0/force_active
    chown system system /sys/devices/virtual/goog_touch_interface/gti.0/fw_ver
    chown system system /sys/devices/virtual/goog_touch_interface/gti.0/ms_base
    chown system system /sys/devices/virtual/goog_touch_interface/gti.0/ms_diff
    chown system system /sys/devices/virtual/goog_touch_interface/gti.0/ms_raw
    chown system system /sys/devices/virtual/goog_touch_interface/gti.0/self_test
    chown system system /sys/devices/virtual/goog_touch_interface/gti.0/ss_base
    chown system system /sys/devices/virtual/goog_touch_interface/gti.0/ss_diff
    chown system system /sys/devices/virtual/goog_touch_interface/gti.0/ss_raw
    # Allow access to touch
    chown system input /dev/touch_offload
    chmod 660 /dev/touch_offload

# Route touch_sensitivity_mode to persist
on property:debug.touch_sensitivity_mode=0
    setprop persist.vendor.touch_sensitivity_mode 0

on property:debug.touch_sensitivity_mode=1
    setprop persist.vendor.touch_sensitivity_mode 1

on property:init.svc.vendor.charger=running
    stop keymaster-4-0

    setprop sys.usb.configfs 1
    setprop vendor.setup.power 1

    # keep one little and one big
    write /sys/devices/system/cpu/cpu1/online 0
    write /sys/devices/system/cpu/cpu2/online 0
    write /sys/devices/system/cpu/cpu3/online 0
    write /sys/devices/system/cpu/cpu4/online 0
    write /sys/devices/system/cpu/cpu5/online 0
    write /sys/devices/system/cpu/cpu7/online 0

on property:sys.boot_completed=1
    # Enable ZRAM on boot_complete
    swapon_all /vendor/etc/fstab.${ro.board.platform}
    write /proc/sys/vm/swappiness 60

    # Set kswapd affinity
    write /sys/kernel/vendor_mm/kswapd_cpu_affinity 7f

    # Set kcompactd affinity
    write /sys/kernel/vendor_mm/kcompactd_cpu_affinity 7f

    # Adjust watermark level
    write /proc/sys/vm/watermark_scale_factor 200

    # Back to default VM settings
    write /proc/sys/vm/dirty_expire_centisecs 3000
    write /proc/sys/vm/dirty_background_ratio 10

    # Setup final cpuset
    write /dev/cpuset/top-app/cpus 0-7
    write /dev/cpuset/foreground/cpus 0-6
    write /dev/cpuset/foreground_window/cpus 0-6
    write /dev/cpuset/background/cpus 0-2
    write /dev/cpuset/system-background/cpus 0-4
    write /dev/cpuset/restricted/cpus 0-1
    write /dev/cpuset/camera-daemon/cpus 0-7
    setprop vendor.powerhal.init 1

    # Restore adjusment for boot
    write /proc/vendor_sched/groups/sys/uclamp_min 0
    write /proc/vendor_sched/groups/ta/prefer_high_cap 0
    write /proc/vendor_sched/groups/fg/prefer_high_cap 0
    write /proc/vendor_sched/groups/sys/prefer_high_cap 0
    write /proc/vendor_sched/groups/fg/ug 2
    write /proc/vendor_sched/groups/sys/ug 2
    write /proc/vendor_sched/groups/nnapi/ug 2

    # Set uclamp.max for some groups, which could indicate cpu importance used in scheduling
    write /proc/vendor_sched/auto_uclamp_max "130 130 512 512 512 512 512 670"
    write /proc/vendor_sched/groups/bg/uclamp_max 130
    write /proc/vendor_sched/groups/sys_bg/uclamp_max 512
    write /proc/vendor_sched/groups/ota/uclamp_max 512
    write /proc/vendor_sched/groups/dex2oat/uclamp_max -2

    write /proc/vendor_sched/uclamp_max_filter_divider 4
    write /proc/vendor_sched/uclamp_max_filter_rt 16
    write /proc/vendor_sched/uclamp_max_filter_enable 1

    # Set PMU freq limit parameters
    write /sys/devices/system/cpu/cpufreq/policy0/sched_pixel/lcpi_threshold 2
    write /sys/devices/system/cpu/cpufreq/policy0/sched_pixel/spc_threshold 59
    write /sys/devices/system/cpu/cpufreq/policy0/sched_pixel/limit_frequency 9999999
    write /sys/devices/system/cpu/cpufreq/policy2/sched_pixel/lcpi_threshold 2
    write /sys/devices/system/cpu/cpufreq/policy2/sched_pixel/spc_threshold 59
    write /sys/devices/system/cpu/cpufreq/policy2/sched_pixel/limit_frequency 9999999
    write /sys/devices/system/cpu/cpufreq/policy5/sched_pixel/lcpi_threshold 6
    write /sys/devices/system/cpu/cpufreq/policy5/sched_pixel/spc_threshold 64
    write /sys/devices/system/cpu/cpufreq/policy5/sched_pixel/limit_frequency 9999999
    write /sys/devices/system/cpu/cpufreq/policy7/sched_pixel/lcpi_threshold 5
    write /sys/devices/system/cpu/cpufreq/policy7/sched_pixel/spc_threshold 69
    write /sys/devices/system/cpu/cpufreq/policy7/sched_pixel/limit_frequency 9999999
    write /proc/vendor_sched/pmu_poll_time 10

    write /proc/vendor_sched/per_cpu_iowait_boost_max_value 720

    # gvotables for dumpstate
    chown system system /sys/kernel/debug/gvotables

    # Permission for wireless charging
    chown system system /sys/class/power_supply/wireless/capacity
    chown system system /sys/class/power_supply/wireless/device/rtx
    chown system system /sys/class/power_supply/wireless/device/rxdata
    chown system system /sys/class/power_supply/wireless/device/txdata
    chown system system /sys/class/power_supply/wireless/device/rxlen
    chown system system /sys/class/power_supply/wireless/device/txlen
    chown system system /sys/class/power_supply/wireless/device/ccreset
    chown system system /sys/class/power_supply/wireless/device/status
    chown system system /sys/class/power_supply/wireless/device/version

    # AOC reset permission
    chown root system /sys/devices/platform/19000000.aoc/reset
    chmod 0220 /sys/devices/platform/19000000.aoc/reset

    # AOC UDFPS clock compensation permission
    chown system system /sys/devices/platform/17000000.aoc/control/udfps_set_clock_source
    chmod 220 /sys/devices/platform/17000000.aoc/control/udfps_set_clock_source
    chown system system /sys/devices/platform/17000000.aoc/control/udfps_get_osc_freq
    chmod 440 /sys/devices/platform/17000000.aoc/control/udfps_get_osc_freq
    chown system system /sys/devices/platform/17000000.aoc/control/udfps_get_disp_freq
    chmod 440 /sys/devices/platform/17000000.aoc/control/udfps_get_disp_freq

    # write serialno to battery path for pairing
    write /sys/class/power_supply/battery/dev_sn ${ro.boot.serialno}

    # Disable GPU firmware logging
    write /sys/devices/platform/1f000000.mali/firmware_config/Log\ verbosity/cur 0

#Enable SICD
    write /sys/devices/system/cpu/cpupm/cpupm/sicd 1

on property:sys.boot_completed=1 && property:persist.sys.device_provisioned=1
    write /sys/class/power_supply/battery/first_usage_date 0

# IMS WiFi Calling
    service charonservice /system/vendor/bin/charon
    class main
    user root
    disabled
    seclabel u:r:charonservice:s0

on property:vendor.charon.exec=1
    rm /data/vendor/misc/vpn/charon.pid
    chmod 0666 /dev/tun
    start charonservice

on property:vendor.charon.exec=0
    stop charonservice
    rm /data/vendor/misc/vpn/charon.pid

# charger driver exposes now finer grain control, map demo mode to those properties
# NOTE: demo mode can only be exit wiping data (which reset the persist properties)
on property:sys.retaildemo.enabled=1
    setprop persist.vendor.charge.stop.level 35
    setprop persist.vendor.charge.start.level 30

# Test Harness Mode default battery profile.
on  property:persist.sys.test_harness=1 && property:persist.vendor.testing_battery_profile=0
    setprop persist.vendor.charge.stop.level 70
    setprop persist.vendor.charge.start.level 35
    setprop vendor.battery.defender.disable 1

# Extremely restricted battery profile.
on  property:persist.sys.test_harness=1 && property:persist.vendor.testing_battery_profile=1
    setprop persist.vendor.charge.stop.level 50
    setprop persist.vendor.charge.start.level 35
    setprop vendor.battery.defender.disable 1

# Normal behavior (as if the device was a regular device)
on  property:persist.sys.test_harness=1 && property:persist.vendor.testing_battery_profile=2
    setprop persist.vendor.charge.stop.level 100
    setprop persist.vendor.charge.start.level 0

# Unrestricted, allows charging to 100%
on  property:persist.sys.test_harness=1 && property:persist.vendor.testing_battery_profile=3
    setprop persist.vendor.charge.stop.level 100
    setprop persist.vendor.charge.start.level 0
    setprop vendor.battery.defender.disable 1

# Zombie sets charge stop level.
on  property:sota.charge.stop.level=*
    write /sys/devices/platform/google,charger/charge_stop_level ${sota.charge.stop.level}

# bugreport is triggered by holding down volume down, volume up and power
service bugreport /system/bin/dumpstate -d -p -z
    class main
    disabled
    oneshot
    keycodes 114 115 116
    user root

service storageproxyd /vendor/bin/storageproxyd \
	-d /dev/trusty-ipc-dev0 \
	-r /dev/sg1 \
	-p /data/vendor/ss \
	-t ufs \
	-f 0:/dev/block/platform/3c400000\.ufs/by-name/trusty_userdata \
	-f persist/0:/dev/block/platform/3c400000\.ufs/by-name/trusty_persist \
	-m /dev/block/platform/3c400000\.ufs/by-name/trusty_userdata
    class early_hal
    user system
    group system
    task_profiles MaxPerformance

# Write build info to kdebuginfo
on property:ro.build.fingerprint=*
    write /sys/module/debug_kinfo/parameters/build_info ${ro.build.fingerprint}

# Bluetooth
on post-fs-data
    mkdir /data/vendor/bluetooth 0770 bluetooth system

on early-boot
    chown bluetooth system /sys/devices/platform/175b0000.serial/serial0/serial0-0/bluetooth/hci0/rfkill0/state
    chown bluetooth system /sys/devices/platform/odm/odm:btbcm/rfkill/rfkill0/state
    chown bluetooth system /sys/devices/platform/odm/odm:btbcm/rfkill/rfkill2/state
    chown bluetooth system /proc/bluetooth/sleep/btwake
    chown bluetooth system /proc/bluetooth/sleep/lpm
    chown bluetooth system /proc/bluetooth/sleep/btwrite
    chown bluetooth system /proc/bluetooth/timesync

# ODPM
on fs
    chown system system /sys/devices/platform/acpm_mfd_bus@18100000/i2c-7/i2c-s2mpg12mfd/s2mpg12-meter/s2mpg12-odpm/iio\:device0/enabled_rails
    chown system system /sys/devices/platform/acpm_mfd_bus@18110000/i2c-8/i2c-s2mpg13mfd/s2mpg13-meter/s2mpg13-odpm/iio\:device1/enabled_rails

on post-fs-data
    mkdir /data/vendor/powerstats 0771 system system
    chown system system /data/vendor/powerstats
    # Thermal Residency Stats (write 1 to reset)
    chown system system /sys/kernel/metrics/thermal/tr_by_group/tmu/stats_reset
    chown system system /sys/kernel/metrics/thermal/tr_by_group/spmic/stats_reset

on late-init && property:ro.boot.cdt_hwid=0x00070303000101010000000000000000
    setprop vendor.thermal.config "thermal_info_config_wingboard.json"

on late-init && property:ro.boot.cdt_hwid=0x00070403000101010000000000000000
    setprop vendor.thermal.config "thermal_info_config_wingboard.json"

on late-init && property:ro.boot.cdt_hwid=0x00070502000101010000000000000000
    setprop vendor.thermal.config "thermal_info_config_wingboard.json"

on late-init && property:ro.boot.cdt_hwid=0x00070502000101010000000100000000
    setprop vendor.thermal.config "thermal_info_config_wingboard.json"

on late-init && property:ro.boot.cdt_hwid=0x00070503000101010000000000000000
    setprop vendor.thermal.config "thermal_info_config_wingboard.json"

on late-init && property:ro.boot.cdt_hwid=0x00070603000101010000000000000000
    setprop vendor.thermal.config "thermal_info_config_wingboard.json"

on charger
    # Use charger thermal config
    setprop vendor.thermal.config "thermal_info_config_charge.json"

    # Wait for insmod_sh to finish all common modules
    wait_for_prop vendor.common.modules.ready 1

    # Create thermal symlink in off charging mode
    mkdir /dev/thermal 0750 system system
    mkdir /dev/thermal/tz-by-name 0750 system system
    mkdir /dev/thermal/cdev-by-name 0750 system system
    start vendor.thermal.symlinks

on property:vendor.disable.bcl.control=1
    write /sys/devices/virtual/pmic/mitigation/instruction/enable_mitigation 0

on property:vendor.disable.bcl.control=0
    write /sys/devices/virtual/pmic/mitigation/instruction/enable_mitigation 1

# UDFPS
on post-fs-data && property:ro.vendor.factory=1
    # HBM mode for UDFPS factory apk
    chmod 666 /d/dri/0/DSI-1/panel/reg/payload
    chmod 666 /d/dri/0/DSI-1/panel/reg/count
    chmod 666 /d/dri/0/DSI-1/panel/reg/address
    chmod 666 /d/dri/0/DSI-1/panel/hbm_mode
    chmod 666 /sys/class/backlight/panel0-backlight/local_hbm_max_timeout
    chmod 666 /sys/class/backlight/panel0-backlight/local_hbm_mode
    chmod 666 /sys/class/backlight/panel0-backlight/hbm_mode

# Modem Service
on property:vendor.device.modules.ready=1
    # Temperature driver
    chown radio system /sys/devices/platform/cp-tm1/cp_temp
    # PCIe Dynamic Speed
    chown radio system /sys/devices/platform/cpif/dynamic_pcie_spd/tp_threshold
    chown radio system /sys/devices/platform/cpif/dynamic_pcie_spd/tp_hysteresis
    chown radio system /sys/devices/platform/cpif/dynamic_pcie_spd/dynamic_spd_enable
    # Modem uart
    chmod 0660 /sys/bus/platform/drivers/goog-dw-apb-uart/unbind
    chown root system /sys/bus/platform/drivers/goog-dw-apb-uart/unbind
    chmod 0660 /sys/bus/platform/drivers/goog-dw-apb-uart/bind
    chown root system /sys/bus/platform/drivers/goog-dw-apb-uart/bind

# MTE
on property:persist.device_config.runtime_native_boot.mode_override=sync
    # Per-core mode overrides.
    write /sys/devices/system/cpu/cpu0/mte_tcf_preferred sync
    write /sys/devices/system/cpu/cpu1/mte_tcf_preferred sync
    write /sys/devices/system/cpu/cpu2/mte_tcf_preferred sync
    write /sys/devices/system/cpu/cpu3/mte_tcf_preferred sync
    write /sys/devices/system/cpu/cpu4/mte_tcf_preferred sync
    write /sys/devices/system/cpu/cpu5/mte_tcf_preferred sync
    write /sys/devices/system/cpu/cpu6/mte_tcf_preferred sync
    write /sys/devices/system/cpu/cpu7/mte_tcf_preferred sync

on property:persist.device_config.runtime_native_boot.mode_override=asymm
    # Per-core mode overrides.
    write /sys/devices/system/cpu/cpu0/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu1/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu2/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu3/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu4/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu5/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu6/mte_tcf_preferred asymm
    write /sys/devices/system/cpu/cpu7/mte_tcf_preferred asymm

# NFC
on post-fs-data
    mkdir /data/vendor/nfc 0770 nfc nfc

# VTS
on property:ro.boot.hw_wrapped_keys.kdf=*
    setprop ro.crypto.hw_wrapped_keys.kdf ${ro.boot.hw_wrapped_keys.kdf}
